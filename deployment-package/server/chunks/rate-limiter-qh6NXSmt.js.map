{"version":3,"file":"rate-limiter-qh6NXSmt.js","sources":["../../../.svelte-kit/adapter-node/chunks/rate-limiter.js"],"sourcesContent":["import { json } from \"@sveltejs/kit\";\nimport { l as logger, L as LogLevel } from \"./logger.js\";\nclass MemoryRateLimitStore {\n  store = /* @__PURE__ */ new Map();\n  cleanupInterval;\n  constructor() {\n    this.cleanupInterval = setInterval(() => {\n      this.cleanup();\n    }, 60 * 1e3);\n  }\n  get(key) {\n    const entry = this.store.get(key);\n    if (entry && Date.now() > entry.resetTime) {\n      this.store.delete(key);\n      return void 0;\n    }\n    return entry;\n  }\n  set(key, entry) {\n    this.store.set(key, entry);\n  }\n  increment(key, windowMs) {\n    const now = Date.now();\n    const existing = this.get(key);\n    if (!existing || now > existing.resetTime) {\n      const newEntry = {\n        requests: 1,\n        resetTime: now + windowMs\n      };\n      this.set(key, newEntry);\n      return newEntry;\n    }\n    existing.requests++;\n    this.set(key, existing);\n    return existing;\n  }\n  cleanup() {\n    const now = Date.now();\n    for (const [key, entry] of this.store.entries()) {\n      if (now > entry.resetTime) {\n        this.store.delete(key);\n      }\n    }\n  }\n  destroy() {\n    if (this.cleanupInterval) {\n      clearInterval(this.cleanupInterval);\n    }\n    this.store.clear();\n  }\n}\nconst defaultStore = new MemoryRateLimitStore();\nfunction defaultKeyGenerator(event) {\n  const forwarded = event.request.headers.get(\"x-forwarded-for\");\n  const ip = forwarded?.split(\",\")[0] || event.request.headers.get(\"x-real-ip\") || event.getClientAddress();\n  return `ip:${ip}`;\n}\nfunction createRateLimit(config) {\n  const {\n    windowMs,\n    requests: maxRequests,\n    skipSuccessfulRequests = false,\n    skipFailedRequests = false,\n    keyGenerator = defaultKeyGenerator,\n    onLimitReached\n  } = config;\n  return async (event) => {\n    const key = keyGenerator(event);\n    const entry = defaultStore.increment(key, windowMs);\n    const resetTimeSeconds = Math.ceil(entry.resetTime / 1e3);\n    const remainingRequests = Math.max(0, maxRequests - entry.requests);\n    if (entry.requests > maxRequests) {\n      logger.logSecurity(LogLevel.WARN, \"Rate limit exceeded\", {\n        component: \"rate_limiter\",\n        event: \"limit_exceeded\",\n        details: {\n          key,\n          requests: entry.requests,\n          maxRequests,\n          windowMs,\n          ip: event.getClientAddress(),\n          userAgent: event.request.headers.get(\"user-agent\"),\n          path: event.url.pathname,\n          method: event.request.method\n        }\n      });\n      if (onLimitReached) {\n        onLimitReached(event, entry.resetTime);\n      }\n      return json(\n        {\n          error: \"Too many requests\",\n          message: \"Rate limit exceeded. Please try again later.\",\n          retryAfter: Math.ceil((entry.resetTime - Date.now()) / 1e3)\n        },\n        {\n          status: 429,\n          headers: {\n            \"X-RateLimit-Limit\": maxRequests.toString(),\n            \"X-RateLimit-Remaining\": \"0\",\n            \"X-RateLimit-Reset\": resetTimeSeconds.toString(),\n            \"Retry-After\": Math.ceil((entry.resetTime - Date.now()) / 1e3).toString()\n          }\n        }\n      );\n    }\n    event.setHeaders({\n      \"X-RateLimit-Limit\": maxRequests.toString(),\n      \"X-RateLimit-Remaining\": remainingRequests.toString(),\n      \"X-RateLimit-Reset\": resetTimeSeconds.toString()\n    });\n    return null;\n  };\n}\n({\n  // General API endpoints\n  api: createRateLimit({\n    windowMs: 15 * 60 * 1e3,\n    // 15 minutes\n    requests: 100\n    // 100 requests per 15 minutes\n  }),\n  // Authentication endpoints (stricter)\n  auth: createRateLimit({\n    windowMs: 15 * 60 * 1e3,\n    // 15 minutes\n    requests: 10,\n    // 10 attempts per 15 minutes\n    onLimitReached: (event, resetTime) => {\n      logger.logSecurity(LogLevel.ERROR, \"Authentication rate limit exceeded\", {\n        component: \"auth_rate_limiter\",\n        event: \"auth_limit_exceeded\",\n        details: {\n          ip: event.getClientAddress(),\n          userAgent: event.request.headers.get(\"user-agent\"),\n          path: event.url.pathname,\n          resetTime: new Date(resetTime).toISOString()\n        }\n      });\n    }\n  }),\n  // File upload endpoints\n  upload: createRateLimit({\n    windowMs: 10 * 60 * 1e3,\n    // 10 minutes\n    requests: 5\n    // 5 uploads per 10 minutes\n  }),\n  // Admin endpoints (more lenient for authenticated users)\n  admin: createRateLimit({\n    windowMs: 5 * 60 * 1e3,\n    // 5 minutes\n    requests: 50\n    // 50 requests per 5 minutes\n  }),\n  // Health check endpoint (very lenient)\n  health: createRateLimit({\n    windowMs: 60 * 1e3,\n    // 1 minute\n    requests: 60\n    // 60 requests per minute\n  }),\n  // WebSocket connections\n  websocket: createRateLimit({\n    windowMs: 60 * 1e3,\n    // 1 minute\n    requests: 10\n    // 10 connection attempts per minute\n  })\n});\nexport {\n  createRateLimit\n};\n"],"names":[],"mappings":"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"}