# =============================================================================
# Nginx Configuration for Boutique Client Portal - Development/Staging
# =============================================================================
# 
# This configuration provides:
# - HTTP-only setup for development (no SSL complexity)
# - Reverse proxy for SvelteKit development server
# - WebSocket support for real-time features and HMR
# - Basic security headers
# - Development-friendly error pages and logging
# 
# Usage:
#   - For local development with custom domain (optional)
#   - For staging environment without SSL complexity
#   - Testing Nginx configuration before production
#
# =============================================================================

# Development HTTP Server
server {
    listen 80;
    listen [::]:80;
    server_name localhost boutique-dev.local *.ngrok.io;

    # =============================================================================
    # Basic Security Headers (Development)
    # =============================================================================
    
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options SAMEORIGIN;  # Less restrictive for dev
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy "strict-origin-when-cross-origin";
    
    # Remove server tokens
    server_tokens off;

    # =============================================================================
    # Development Logging
    # =============================================================================
    
    # Detailed logging for development
    log_format dev '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $bytes_sent '
                   '"$http_referer" "$http_user_agent" '
                   '$request_time $upstream_response_time '
                   '"$upstream_addr"';
    
    access_log /var/log/nginx/boutique-dev.access.log dev;
    error_log /var/log/nginx/boutique-dev.error.log debug;

    # =============================================================================
    # Performance (Relaxed for Development)
    # =============================================================================
    
    # Basic gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 3;  # Lower compression for faster response
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # =============================================================================
    # WebSocket Support (Development + HMR)
    # =============================================================================
    
    # WebSocket proxy for app WebSocket features
    location /ws {
        proxy_pass http://127.0.0.1:8743;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Development-friendly timeouts
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
        proxy_connect_timeout 10s;
        
        proxy_buffering off;
        proxy_cache off;
    }
    
    # Vite HMR WebSocket support
    location /vite-hmr {
        proxy_pass http://127.0.0.1:5173;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
        proxy_connect_timeout 10s;
        
        proxy_buffering off;
        proxy_cache off;
    }

    # =============================================================================
    # Static Assets (Development)
    # =============================================================================
    
    # Short cache for development
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 5m;  # Short cache for development
        add_header Cache-Control "public";
        add_header Vary Accept-Encoding;
        
        try_files $uri @sveltekit;
    }
    
    # Favicon
    location = /favicon.ico {
        expires 1h;
        try_files $uri @sveltekit;
    }

    # =============================================================================
    # API Routes (Development)
    # =============================================================================
    
    # All API routes - no rate limiting in development
    location /api/ {
        proxy_pass http://127.0.0.1:5173;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Development-friendly timeouts
        proxy_read_timeout 300s;  # Longer for debugging
        proxy_send_timeout 300s;
        proxy_connect_timeout 10s;
        
        proxy_cache_bypass $http_upgrade;
        
        # Development headers
        add_header X-Dev-Mode "enabled" always;
        add_header X-API-Version "1.0-dev" always;
    }

    # =============================================================================
    # Health Check (Development)
    # =============================================================================
    
    location = /health {
        proxy_pass http://127.0.0.1:5173;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_read_timeout 10s;
        proxy_send_timeout 10s;
        proxy_connect_timeout 5s;
        
        # No caching for health checks
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # =============================================================================
    # Development Tools and Endpoints
    # =============================================================================
    
    # Vite dev server files
    location /@vite/ {
        proxy_pass http://127.0.0.1:5173;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
    
    # Source maps (development only)
    location ~* \.map$ {
        expires 1m;
        add_header Cache-Control "no-cache";
        try_files $uri @sveltekit;
    }

    # =============================================================================
    # Main Application (SvelteKit Development)
    # =============================================================================
    
    location @sveltekit {
        proxy_pass http://127.0.0.1:5173;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Development-friendly settings
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
        proxy_connect_timeout 10s;
        
        # Buffer settings
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
        
        # Development headers
        add_header X-Dev-Mode "enabled" always;
    }
    
    # Default location
    location / {
        try_files $uri @sveltekit;
    }

    # =============================================================================
    # Development-Friendly Error Handling
    # =============================================================================
    
    # Show detailed error pages in development
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    
    location = /404.html {
        return 404 '<!DOCTYPE html>
<html>
<head><title>404 Not Found</title></head>
<body>
<h1>404 Not Found (Development)</h1>
<p>The requested resource was not found.</p>
<p>Server: $server_name</p>
<p>URI: $request_uri</p>
<p>Time: $time_local</p>
</body>
</html>';
    }
    
    location = /50x.html {
        return 500 '<!DOCTYPE html>
<html>
<head><title>Server Error</title></head>
<body>
<h1>Server Error (Development)</h1>
<p>An error occurred while processing your request.</p>
<p>Check the development server logs for details.</p>
<p>Server: $server_name</p>
<p>Time: $time_local</p>
</body>
</html>';
    }

    # =============================================================================
    # Block Some Security Threats (Basic)
    # =============================================================================
    
    # Block access to hidden files
    location ~ /\. {
        deny all;
        return 404;
    }
    
    # Block access to development files that shouldn't be public
    location ~* \.(env|log|tmp|bak|backup)$ {
        deny all;
        return 404;
    }
}

# =============================================================================
# HTTPS Development Server (with self-signed cert)
# =============================================================================

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name localhost boutique-dev.local;

    # Self-signed certificates for HTTPS development
    # Generate with: openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout dev.key -out dev.crt
    ssl_certificate /etc/nginx/ssl/dev.crt;
    ssl_certificate_key /etc/nginx/ssl/dev.key;
    
    # Basic SSL settings for development
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout 10m;
    
    # Development HSTS (short duration)
    add_header Strict-Transport-Security "max-age=300";
    
    # Same configuration as HTTP server
    include /etc/nginx/conf.d/boutique-dev-common.conf;
}