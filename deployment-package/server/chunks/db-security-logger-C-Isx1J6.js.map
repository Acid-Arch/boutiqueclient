{"version":3,"file":"db-security-logger-C-Isx1J6.js","sources":["../../../.svelte-kit/adapter-node/chunks/db-security-logger.js"],"sourcesContent":["import { d as dev } from \"./index.js\";\nconst SENSITIVE_QUERIES = [\n  \"users\",\n  \"login_attempts\",\n  \"sessions\",\n  \"oauth_accounts\",\n  \"audit_logs\",\n  \"password\",\n  \"secret\",\n  \"token\"\n];\nconst SUSPICIOUS_PATTERNS = [\n  /UNION.*SELECT/i,\n  /OR.*1.*=.*1/i,\n  /WHERE.*1.*=.*1/i,\n  /DROP.*TABLE/i,\n  /DELETE.*FROM.*users/i,\n  /UPDATE.*users.*SET.*password/i,\n  /INSERT.*INTO.*users/i,\n  /'.*OR.*/i,\n  /;.*--/i,\n  /\\/\\*.*\\*\\//i\n];\nclass DatabaseSecurityLogger {\n  static logs = [];\n  static MAX_LOGS = 1e3;\n  /**\n   * Log a database query for security monitoring\n   */\n  static logQuery(query, params = [], duration, context) {\n    const queryType = this.getQueryType(query);\n    const isSensitive = this.isSensitiveQuery(query);\n    const isSuspicious = this.isSuspiciousQuery(query, params);\n    if (isSensitive || isSuspicious || context?.error || dev) {\n      const logEntry = {\n        query: this.sanitizeQuery(query),\n        params: this.sanitizeParams(params),\n        duration,\n        timestamp: /* @__PURE__ */ new Date(),\n        userId: context?.userId,\n        ip: context?.ip,\n        userAgent: context?.userAgent,\n        error: context?.error,\n        queryType\n      };\n      this.addLog(logEntry);\n      if (isSuspicious) {\n        console.warn(\"🚨 SUSPICIOUS DATABASE QUERY DETECTED:\", {\n          query: logEntry.query,\n          params: logEntry.params,\n          context\n        });\n      }\n      if (duration > 5e3) {\n        console.warn(\"🐌 SLOW DATABASE QUERY:\", {\n          query: logEntry.query,\n          duration: `${duration}ms`,\n          context\n        });\n      }\n    }\n  }\n  /**\n   * Get query type from SQL string\n   */\n  static getQueryType(query) {\n    const normalizedQuery = query.trim().toUpperCase();\n    if (normalizedQuery.startsWith(\"SELECT\")) return \"SELECT\";\n    if (normalizedQuery.startsWith(\"INSERT\")) return \"INSERT\";\n    if (normalizedQuery.startsWith(\"UPDATE\")) return \"UPDATE\";\n    if (normalizedQuery.startsWith(\"DELETE\")) return \"DELETE\";\n    return \"OTHER\";\n  }\n  /**\n   * Check if query involves sensitive data\n   */\n  static isSensitiveQuery(query) {\n    const lowerQuery = query.toLowerCase();\n    return SENSITIVE_QUERIES.some((table) => lowerQuery.includes(table));\n  }\n  /**\n   * Check if query contains suspicious patterns\n   */\n  static isSuspiciousQuery(query, params = []) {\n    if (SUSPICIOUS_PATTERNS.some((pattern) => pattern.test(query))) {\n      return true;\n    }\n    const allParams = params.map((p) => String(p)).join(\" \");\n    if (SUSPICIOUS_PATTERNS.some((pattern) => pattern.test(allParams))) {\n      return true;\n    }\n    return false;\n  }\n  /**\n   * Sanitize query for logging (remove sensitive data)\n   */\n  static sanitizeQuery(query) {\n    return query.replace(\n      /(password|secret|token|key)\\s*=\\s*[$]?\\d+/gi,\n      \"$1 = [REDACTED]\"\n    );\n  }\n  /**\n   * Sanitize parameters for logging\n   */\n  static sanitizeParams(params) {\n    return params.map((param, index) => {\n      if (typeof param === \"string\" && param.length > 50) {\n        return `${param.substring(0, 50)}... [TRUNCATED]`;\n      }\n      if (typeof param === \"string\" && /password|secret|token/i.test(param)) {\n        return \"[REDACTED]\";\n      }\n      return param;\n    });\n  }\n  /**\n   * Add log entry with rotation\n   */\n  static addLog(logEntry) {\n    this.logs.push(logEntry);\n    if (this.logs.length > this.MAX_LOGS) {\n      this.logs.splice(0, this.logs.length - this.MAX_LOGS);\n    }\n  }\n  /**\n   * Get recent suspicious activities\n   */\n  static getSuspiciousActivities(limit = 50) {\n    const now = /* @__PURE__ */ new Date();\n    const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1e3);\n    return this.logs.filter(\n      (log) => log.timestamp > oneHourAgo && (this.isSuspiciousQuery(log.query, log.params) || log.error)\n    ).slice(-limit);\n  }\n  /**\n   * Get security statistics\n   */\n  static getSecurityStats() {\n    const now = /* @__PURE__ */ new Date();\n    const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1e3);\n    const recentLogs = this.logs.filter((log) => log.timestamp > oneHourAgo);\n    return {\n      totalQueries: recentLogs.length,\n      suspiciousQueries: recentLogs.filter(\n        (log) => this.isSuspiciousQuery(log.query, log.params)\n      ).length,\n      errorQueries: recentLogs.filter((log) => log.error).length,\n      slowQueries: recentLogs.filter((log) => log.duration > 5e3).length,\n      lastActivity: this.logs.length > 0 ? this.logs[this.logs.length - 1].timestamp : null\n    };\n  }\n  /**\n   * Clear logs (for testing or privacy)\n   */\n  static clearLogs() {\n    this.logs.length = 0;\n  }\n}\nasync function monitoredQuery(queryFn, query, params = [], context) {\n  const startTime = Date.now();\n  let error;\n  try {\n    const result = await queryFn();\n    const duration = Date.now() - startTime;\n    DatabaseSecurityLogger.logQuery(query, params, duration, context);\n    return result;\n  } catch (err) {\n    const duration = Date.now() - startTime;\n    error = err instanceof Error ? err.message : String(err);\n    DatabaseSecurityLogger.logQuery(query, params, duration, {\n      ...context,\n      error\n    });\n    throw err;\n  }\n}\nexport {\n  DatabaseSecurityLogger as D,\n  monitoredQuery as m\n};\n"],"names":[],"mappings":"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"}