{"version":3,"file":"_server.ts-B7TXThkD.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/auth/oauth/callback/_server.ts.js"],"sourcesContent":["import { redirect, json } from \"@sveltejs/kit\";\nimport { O as OAuthService } from \"../../../../../../chunks/oauth-service.js\";\nconst GET = async ({ url, cookies, locals }) => {\n  try {\n    const returnUrl = cookies.get(\"oauth_return_url\") || \"/client-portal\";\n    cookies.delete(\"oauth_return_url\", { path: \"/\" });\n    const error = url.searchParams.get(\"error\");\n    if (error) {\n      console.error(\"OAuth callback error:\", error);\n      throw redirect(302, `/login?error=oauth_error&message=${encodeURIComponent(error)}`);\n    }\n    if (locals.user) {\n      const successUrl = new URL(returnUrl, url.origin);\n      successUrl.searchParams.set(\"oauth_success\", \"true\");\n      throw redirect(302, successUrl.toString());\n    }\n    throw redirect(302, \"/login?error=oauth_no_session\");\n  } catch (err) {\n    console.error(\"OAuth callback processing error:\", err);\n    if (err instanceof Error && \"status\" in err) {\n      throw err;\n    }\n    throw redirect(302, \"/login?error=oauth_callback_failed\");\n  }\n};\nconst POST = async ({ request, cookies }) => {\n  try {\n    const body = await request.json();\n    if (!body.user || !body.account || !body.profile) {\n      return json({ error: \"Invalid callback payload\" }, { status: 400 });\n    }\n    const googleProfile = {\n      sub: body.profile.id,\n      email: body.profile.email,\n      name: body.profile.name,\n      given_name: body.profile.given_name,\n      family_name: body.profile.family_name,\n      picture: body.profile.picture\n    };\n    if (!OAuthService.validateGoogleProfile(googleProfile)) {\n      return json({ error: \"Invalid Google profile structure\" }, { status: 400 });\n    }\n    const oauthResult = await OAuthService.handleGoogleCallback(googleProfile);\n    if (!oauthResult.success) {\n      return json({\n        error: \"OAuth authentication failed\",\n        details: oauthResult.error\n      }, { status: 400 });\n    }\n    if (!oauthResult.user) {\n      return json({ error: \"No user data returned\" }, { status: 400 });\n    }\n    const sessionData = await OAuthService.createOAuthSession(oauthResult.user, request);\n    return json({\n      success: true,\n      user: oauthResult.user,\n      session: {\n        token: sessionData.token,\n        cookieOptions: sessionData.cookieOptions\n      },\n      isNewUser: oauthResult.isNewUser,\n      accountLinked: oauthResult.accountLinked\n    });\n  } catch (err) {\n    console.error(\"OAuth POST callback error:\", err);\n    return json({\n      error: \"OAuth callback processing failed\",\n      details: err instanceof Error ? err.message : \"Unknown error\"\n    }, { status: 500 });\n  }\n};\nexport {\n  GET,\n  POST\n};\n"],"names":[],"mappings":"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"}