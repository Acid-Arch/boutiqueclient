{"version":3,"file":"_server.ts-D-kUISCI.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/auth/login/_server.ts.js"],"sourcesContent":["import { json } from \"@sveltejs/kit\";\nimport { A as AuthService } from \"../../../../../chunks/auth-direct.js\";\nimport { v as validateIPAccess, b as recordFailedAttempt } from \"../../../../../chunks/ip-whitelist.js\";\nimport { v as validateAPIRequest } from \"../../../../../chunks/middleware.js\";\nimport { L as LoginSchema } from \"../../../../../chunks/schemas.js\";\nconst POST = async (event) => {\n  console.log(\"üîê Login API endpoint called\");\n  const validation = await validateAPIRequest(event, {\n    bodySchema: LoginSchema,\n    rateLimit: {\n      requests: 5,\n      // 5 attempts\n      windowMs: 15 * 60 * 1e3\n      // per 15 minutes\n    },\n    logRequest: true\n  });\n  if (!validation.success) {\n    return validation.response;\n  }\n  const { emailOrUsername, password, rememberMe } = validation.body;\n  const { request, cookies } = event;\n  try {\n    console.log(\"üìß Login attempt for:\", emailOrUsername);\n    const ipValidation = await validateIPAccess(request, void 0, emailOrUsername.trim());\n    if (!ipValidation.allowed) {\n      if (ipValidation.publicIP) {\n        await recordFailedAttempt(ipValidation.publicIP);\n      }\n      return json(\n        {\n          success: false,\n          error: \"Access denied\",\n          details: {\n            reason: ipValidation.reason,\n            publicIP: ipValidation.publicIP,\n            code: \"IP_ACCESS_DENIED\"\n          }\n        },\n        { status: 403 }\n      );\n    }\n    const loginResult = await AuthService.authenticateUser(emailOrUsername.trim(), password);\n    if (!loginResult.success) {\n      if (ipValidation.publicIP) {\n        await recordFailedAttempt(ipValidation.publicIP, loginResult.user?.id);\n      }\n      return json(\n        {\n          success: false,\n          error: loginResult.error || \"Invalid credentials\"\n        },\n        { status: 401 }\n      );\n    }\n    if (loginResult.user) {\n      const finalIPValidation = await validateIPAccess(\n        request,\n        loginResult.user.id,\n        loginResult.user.email\n      );\n      if (!finalIPValidation.allowed) {\n        if (finalIPValidation.publicIP) {\n          await recordFailedAttempt(finalIPValidation.publicIP, loginResult.user.id);\n        }\n        return json(\n          {\n            success: false,\n            error: \"Access denied for your account from this location\",\n            details: {\n              reason: finalIPValidation.reason,\n              publicIP: finalIPValidation.publicIP,\n              code: \"USER_IP_ACCESS_DENIED\"\n            }\n          },\n          { status: 403 }\n        );\n      }\n    }\n    const sessionToken = AuthService.generateSessionToken();\n    const cookieOptions = AuthService.getSessionCookieOptions();\n    if (rememberMe) {\n      cookieOptions.maxAge = 30 * 24 * 60 * 60;\n    }\n    cookies.set(\"session\", `${loginResult.user.id}:${sessionToken}`, cookieOptions);\n    return json({\n      success: true,\n      user: loginResult.user\n    });\n  } catch (error) {\n    console.error(\"Login API error:\", error);\n    return json(\n      {\n        success: false,\n        error: \"Internal server error\"\n      },\n      { status: 500 }\n    );\n  }\n};\nexport {\n  POST\n};\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAKK,MAAC,IAAI,GAAG,OAAO,KAAK,KAAK;AAC9B,EAAE,OAAO,CAAC,GAAG,CAAC,8BAA8B,CAAC;AAC7C,EAAE,MAAM,UAAU,GAAG,MAAM,kBAAkB,CAAC,KAAK,EAAE;AACrD,IAAI,UAAU,EAAE,WAAW;AAC3B,IAAI,SAAS,EAAE;AACf,MAAM,QAAQ,EAAE,CAAC;AACjB;AACA,MAAM,QAAQ,EAAE,EAAE,GAAG,EAAE,GAAG;AAC1B;AACA,KAAK;AACL,IAAI,UAAU,EAAE;AAChB,GAAG,CAAC;AACJ,EAAE,IAAI,CAAC,UAAU,CAAC,OAAO,EAAE;AAC3B,IAAI,OAAO,UAAU,CAAC,QAAQ;AAC9B,EAAE;AACF,EAAE,MAAM,EAAE,eAAe,EAAE,QAAQ,EAAE,UAAU,EAAE,GAAG,UAAU,CAAC,IAAI;AACnE,EAAE,MAAM,EAAE,OAAO,EAAE,OAAO,EAAE,GAAG,KAAK;AACpC,EAAE,IAAI;AACN,IAAI,OAAO,CAAC,GAAG,CAAC,uBAAuB,EAAE,eAAe,CAAC;AACzD,IAAI,MAAM,YAAY,GAAG,MAAM,gBAAgB,CAAC,OAAO,EAAE,KAAK,CAAC,EAAE,eAAe,CAAC,IAAI,EAAE,CAAC;AACxF,IAAI,IAAI,CAAC,YAAY,CAAC,OAAO,EAAE;AAC/B,MAAM,IAAI,YAAY,CAAC,QAAQ,EAAE;AACjC,QAAQ,MAAM,mBAAmB,CAAC,YAAY,CAAC,QAAQ,CAAC;AACxD,MAAM;AACN,MAAM,OAAO,IAAI;AACjB,QAAQ;AACR,UAAU,OAAO,EAAE,KAAK;AACxB,UAAU,KAAK,EAAE,eAAe;AAChC,UAAU,OAAO,EAAE;AACnB,YAAY,MAAM,EAAE,YAAY,CAAC,MAAM;AACvC,YAAY,QAAQ,EAAE,YAAY,CAAC,QAAQ;AAC3C,YAAY,IAAI,EAAE;AAClB;AACA,SAAS;AACT,QAAQ,EAAE,MAAM,EAAE,GAAG;AACrB,OAAO;AACP,IAAI;AACJ,IAAI,MAAM,WAAW,GAAG,MAAM,WAAW,CAAC,gBAAgB,CAAC,eAAe,CAAC,IAAI,EAAE,EAAE,QAAQ,CAAC;AAC5F,IAAI,IAAI,CAAC,WAAW,CAAC,OAAO,EAAE;AAC9B,MAAM,IAAI,YAAY,CAAC,QAAQ,EAAE;AACjC,QAAQ,MAAM,mBAAmB,CAAC,YAAY,CAAC,QAAQ,EAAE,WAAW,CAAC,IAAI,EAAE,EAAE,CAAC;AAC9E,MAAM;AACN,MAAM,OAAO,IAAI;AACjB,QAAQ;AACR,UAAU,OAAO,EAAE,KAAK;AACxB,UAAU,KAAK,EAAE,WAAW,CAAC,KAAK,IAAI;AACtC,SAAS;AACT,QAAQ,EAAE,MAAM,EAAE,GAAG;AACrB,OAAO;AACP,IAAI;AACJ,IAAI,IAAI,WAAW,CAAC,IAAI,EAAE;AAC1B,MAAM,MAAM,iBAAiB,GAAG,MAAM,gBAAgB;AACtD,QAAQ,OAAO;AACf,QAAQ,WAAW,CAAC,IAAI,CAAC,EAAE;AAC3B,QAAQ,WAAW,CAAC,IAAI,CAAC;AACzB,OAAO;AACP,MAAM,IAAI,CAAC,iBAAiB,CAAC,OAAO,EAAE;AACtC,QAAQ,IAAI,iBAAiB,CAAC,QAAQ,EAAE;AACxC,UAAU,MAAM,mBAAmB,CAAC,iBAAiB,CAAC,QAAQ,EAAE,WAAW,CAAC,IAAI,CAAC,EAAE,CAAC;AACpF,QAAQ;AACR,QAAQ,OAAO,IAAI;AACnB,UAAU;AACV,YAAY,OAAO,EAAE,KAAK;AAC1B,YAAY,KAAK,EAAE,mDAAmD;AACtE,YAAY,OAAO,EAAE;AACrB,cAAc,MAAM,EAAE,iBAAiB,CAAC,MAAM;AAC9C,cAAc,QAAQ,EAAE,iBAAiB,CAAC,QAAQ;AAClD,cAAc,IAAI,EAAE;AACpB;AACA,WAAW;AACX,UAAU,EAAE,MAAM,EAAE,GAAG;AACvB,SAAS;AACT,MAAM;AACN,IAAI;AACJ,IAAI,MAAM,YAAY,GAAG,WAAW,CAAC,oBAAoB,EAAE;AAC3D,IAAI,MAAM,aAAa,GAAG,WAAW,CAAC,uBAAuB,EAAE;AAC/D,IAAI,IAAI,UAAU,EAAE;AACpB,MAAM,aAAa,CAAC,MAAM,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE;AAC9C,IAAI;AACJ,IAAI,OAAO,CAAC,GAAG,CAAC,SAAS,EAAE,CAAC,EAAE,WAAW,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC,EAAE,YAAY,CAAC,CAAC,EAAE,aAAa,CAAC;AACnF,IAAI,OAAO,IAAI,CAAC;AAChB,MAAM,OAAO,EAAE,IAAI;AACnB,MAAM,IAAI,EAAE,WAAW,CAAC;AACxB,KAAK,CAAC;AACN,EAAE,CAAC,CAAC,OAAO,KAAK,EAAE;AAClB,IAAI,OAAO,CAAC,KAAK,CAAC,kBAAkB,EAAE,KAAK,CAAC;AAC5C,IAAI,OAAO,IAAI;AACf,MAAM;AACN,QAAQ,OAAO,EAAE,KAAK;AACtB,QAAQ,KAAK,EAAE;AACf,OAAO;AACP,MAAM,EAAE,MAAM,EAAE,GAAG;AACnB,KAAK;AACL,EAAE;AACF;;;;"}