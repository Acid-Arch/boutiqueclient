{"version":3,"file":"_server.ts-CAhKdEWf.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/metrics/_server.ts.js"],"sourcesContent":["import { json } from \"@sveltejs/kit\";\nimport { m as metrics } from \"../../../../chunks/metrics.js\";\nimport { l as logger, L as LogLevel } from \"../../../../chunks/logger.js\";\nimport { b as rateLimitAdmin } from \"../../../../chunks/rate-limiter-comprehensive.js\";\nconst GET = async (event) => {\n  const { url, locals } = event;\n  const rateLimitResponse = await rateLimitAdmin(event);\n  if (rateLimitResponse) {\n    return rateLimitResponse;\n  }\n  if (!locals.user || locals.user.role !== \"ADMIN\") {\n    return json({\n      error: \"Forbidden: Admin access required\",\n      timestamp: (/* @__PURE__ */ new Date()).toISOString()\n    }, { status: 403 });\n  }\n  try {\n    const format = url.searchParams.get(\"format\") || \"json\";\n    const since = url.searchParams.get(\"since\");\n    const sinceTimestamp = since ? parseInt(since) : void 0;\n    switch (format) {\n      case \"prometheus\":\n        const prometheusMetrics = metrics.exportPrometheusMetrics();\n        logger.logSystem(LogLevel.DEBUG, \"Prometheus metrics exported\", {\n          component: \"metrics-endpoint\",\n          event: \"prometheus_export\",\n          details: {\n            userId: locals.user.id,\n            metricsSize: prometheusMetrics.length\n          }\n        });\n        return new Response(prometheusMetrics, {\n          status: 200,\n          headers: {\n            \"Content-Type\": \"text/plain; charset=utf-8\",\n            \"Cache-Control\": \"no-cache, no-store, must-revalidate\"\n          }\n        });\n      case \"json\":\n      default:\n        const metricsData = metrics.getMetrics(sinceTimestamp);\n        const systemMetrics = metrics.getSystemMetrics();\n        logger.logSystem(LogLevel.DEBUG, \"JSON metrics exported\", {\n          component: \"metrics-endpoint\",\n          event: \"json_export\",\n          details: {\n            userId: locals.user.id,\n            metricsCount: Object.keys(metricsData.metrics).length,\n            period: metricsData.period\n          }\n        });\n        return json({\n          application: metricsData,\n          system: systemMetrics,\n          meta: {\n            format: \"json\",\n            version: \"1.0\",\n            exported_at: (/* @__PURE__ */ new Date()).toISOString(),\n            exported_by: locals.user.email\n          }\n        }, {\n          status: 200,\n          headers: {\n            \"Cache-Control\": \"no-cache, no-store, must-revalidate\"\n          }\n        });\n    }\n  } catch (error) {\n    logger.logSystem(LogLevel.ERROR, \"Metrics endpoint error\", {\n      component: \"metrics-endpoint\",\n      event: \"export_error\",\n      error: error instanceof Error ? error : void 0,\n      details: {\n        userId: locals.user?.id,\n        userAgent: event.request.headers.get(\"user-agent\")\n      }\n    });\n    return json({\n      error: \"Failed to export metrics\",\n      timestamp: (/* @__PURE__ */ new Date()).toISOString(),\n      details: error instanceof Error ? error.message : \"Unknown error\"\n    }, { status: 500 });\n  }\n};\nexport {\n  GET\n};\n"],"names":[],"mappings":"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"}