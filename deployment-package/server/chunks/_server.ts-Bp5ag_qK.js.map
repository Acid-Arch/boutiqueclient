{"version":3,"file":"_server.ts-Bp5ag_qK.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/auth/oauth/google/_server.ts.js"],"sourcesContent":["import { error, json, redirect } from \"@sveltejs/kit\";\nimport { d as dev } from \"../../../../../../chunks/index.js\";\nimport { G as GOOGLE_CLIENT_ID, a as GOOGLE_CLIENT_SECRET } from \"../../../../../../chunks/auth-direct.js\";\nimport { O as OAuthService } from \"../../../../../../chunks/oauth-service.js\";\nconst GET = async ({ url, cookies }) => {\n  const action = url.searchParams.get(\"action\");\n  try {\n    switch (action) {\n      case \"initiate\":\n        await handleOAuthInitiation(url, cookies);\n        return new Response(null, { status: 302 });\n      case \"callback\":\n        await handleOAuthCallback(url, cookies);\n        return new Response(null, { status: 302 });\n      case \"status\":\n        return handleOAuthStatus();\n      default:\n        throw error(400, \"Invalid OAuth action. Use ?action=initiate, ?action=callback, or ?action=status\");\n    }\n  } catch (err) {\n    console.error(\"OAuth endpoint error:\", err);\n    if (err instanceof Error && \"status\" in err) {\n      throw err;\n    }\n    throw error(500, \"OAuth authentication failed\");\n  }\n};\nasync function handleOAuthInitiation(url, cookies) {\n  const state = generateSecureState();\n  const returnUrl = url.searchParams.get(\"returnUrl\") || \"/client-portal\";\n  cookies.set(\"oauth_state\", state, {\n    path: \"/\",\n    httpOnly: true,\n    secure: !dev,\n    sameSite: \"lax\",\n    maxAge: 300\n    // 5 minutes\n  });\n  cookies.set(\"oauth_return_url\", returnUrl, {\n    path: \"/\",\n    httpOnly: true,\n    secure: !dev,\n    sameSite: \"lax\",\n    maxAge: 300\n    // 5 minutes\n  });\n  const baseUrl = \"https://your-domain.com\";\n  const redirectUri = `${baseUrl}/api/auth/oauth/google?action=callback`;\n  const googleAuthUrl = new URL(\"https://accounts.google.com/o/oauth2/v2/auth\");\n  googleAuthUrl.searchParams.set(\"client_id\", GOOGLE_CLIENT_ID);\n  googleAuthUrl.searchParams.set(\"redirect_uri\", redirectUri);\n  googleAuthUrl.searchParams.set(\"response_type\", \"code\");\n  googleAuthUrl.searchParams.set(\"scope\", \"openid email profile\");\n  googleAuthUrl.searchParams.set(\"access_type\", \"offline\");\n  googleAuthUrl.searchParams.set(\"prompt\", \"select_account\");\n  googleAuthUrl.searchParams.set(\"state\", state);\n  throw redirect(302, googleAuthUrl.toString());\n}\nasync function handleOAuthCallback(url, cookies) {\n  const code = url.searchParams.get(\"code\");\n  const state = url.searchParams.get(\"state\");\n  const error_param = url.searchParams.get(\"error\");\n  const storedState = cookies.get(\"oauth_state\");\n  const returnUrl = cookies.get(\"oauth_return_url\") || \"/client-portal\";\n  cookies.delete(\"oauth_state\", { path: \"/\" });\n  cookies.delete(\"oauth_return_url\", { path: \"/\" });\n  if (error_param) {\n    console.error(\"OAuth error from Google:\", error_param);\n    throw redirect(302, `/login?error=oauth_error&message=${encodeURIComponent(error_param)}`);\n  }\n  if (!state || !storedState || state !== storedState) {\n    console.error(\"OAuth state mismatch:\", { received: state, stored: storedState });\n    throw redirect(302, \"/login?error=oauth_state_mismatch\");\n  }\n  if (!code) {\n    console.error(\"Missing OAuth authorization code\");\n    throw redirect(302, \"/login?error=oauth_no_code\");\n  }\n  try {\n    const tokenResponse = await exchangeCodeForTokens(code);\n    const userProfile = await getGoogleUserProfile(tokenResponse.access_token);\n    if (!OAuthService.validateGoogleProfile(userProfile)) {\n      throw new Error(\"Invalid Google profile structure\");\n    }\n    const oauthResult = await OAuthService.handleGoogleCallback(userProfile);\n    if (!oauthResult.success) {\n      console.error(\"OAuth user handling failed:\", oauthResult.error);\n      throw redirect(302, `/login?error=oauth_user_error&message=${encodeURIComponent(oauthResult.error || \"Authentication failed\")}`);\n    }\n    if (!oauthResult.user) {\n      throw new Error(\"No user returned from OAuth handling\");\n    }\n    const sessionData = await OAuthService.createOAuthSession(oauthResult.user, new Request(url.toString()));\n    cookies.set(\"session\", `${oauthResult.user.id}:${sessionData.token}`, sessionData.cookieOptions);\n    const successUrl = new URL(returnUrl, url.origin);\n    if (oauthResult.isNewUser) {\n      successUrl.searchParams.set(\"welcome\", \"true\");\n    }\n    if (oauthResult.accountLinked) {\n      successUrl.searchParams.set(\"linked\", \"true\");\n    }\n    throw redirect(302, successUrl.toString());\n  } catch (err) {\n    console.error(\"OAuth callback processing error:\", err);\n    const errorMessage = err instanceof Error ? err.message : \"Authentication failed\";\n    throw redirect(302, `/login?error=oauth_callback_error&message=${encodeURIComponent(errorMessage)}`);\n  }\n}\nasync function handleOAuthStatus() {\n  return json({\n    provider: \"google\",\n    available: true,\n    clientId: \"configured\",\n    clientSecret: \"configured\",\n    redirectUris: {\n      development: \"http://localhost:5173/api/auth/oauth/google?action=callback\",\n      production: \"https://your-domain.com/api/auth/oauth/google?action=callback\"\n    }\n  });\n}\nasync function exchangeCodeForTokens(code) {\n  const baseUrl = \"https://your-domain.com\";\n  const redirectUri = `${baseUrl}/api/auth/oauth/google?action=callback`;\n  const tokenResponse = await fetch(\"https://oauth2.googleapis.com/token\", {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/x-www-form-urlencoded\"\n    },\n    body: new URLSearchParams({\n      client_id: GOOGLE_CLIENT_ID,\n      client_secret: GOOGLE_CLIENT_SECRET,\n      code,\n      grant_type: \"authorization_code\",\n      redirect_uri: redirectUri\n    })\n  });\n  if (!tokenResponse.ok) {\n    const errorData = await tokenResponse.text();\n    console.error(\"Token exchange failed:\", errorData);\n    throw new Error(\"Failed to exchange authorization code for tokens\");\n  }\n  const tokens = await tokenResponse.json();\n  if (!tokens.access_token) {\n    throw new Error(\"No access token received from Google\");\n  }\n  return tokens;\n}\nasync function getGoogleUserProfile(accessToken) {\n  const profileResponse = await fetch(\"https://www.googleapis.com/oauth2/v2/userinfo\", {\n    headers: {\n      \"Authorization\": `Bearer ${accessToken}`\n    }\n  });\n  if (!profileResponse.ok) {\n    const errorData = await profileResponse.text();\n    console.error(\"Profile fetch failed:\", errorData);\n    throw new Error(\"Failed to fetch user profile from Google\");\n  }\n  const profile = await profileResponse.json();\n  if (!profile.id || !profile.email || !profile.name) {\n    throw new Error(\"Incomplete profile data from Google\");\n  }\n  return profile;\n}\nfunction generateSecureState() {\n  const array = new Uint8Array(32);\n  crypto.getRandomValues(array);\n  return btoa(String.fromCharCode(...array)).replace(/\\+/g, \"-\").replace(/\\//g, \"_\").replace(/=/g, \"\");\n}\nexport {\n  GET\n};\n"],"names":[],"mappings":"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"}