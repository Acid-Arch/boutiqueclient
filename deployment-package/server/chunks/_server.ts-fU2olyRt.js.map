{"version":3,"file":"_server.ts-fU2olyRt.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/scraping/dashboard/stats/_server.ts.js"],"sourcesContent":["import { json } from \"@sveltejs/kit\";\nimport { getDb, getAccountsCount, query } from \"../../../../../../chunks/db-loader.js\";\nconst GET = async ({ url, locals }) => {\n  try {\n    const stats = await getDashboardStats();\n    return json(stats);\n  } catch (error) {\n    console.error(\"Dashboard stats error:\", error);\n    return json(\n      { error: \"Failed to load dashboard statistics\" },\n      { status: 500 }\n    );\n  }\n};\nasync function getDashboardStats() {\n  try {\n    const db = await getDb();\n    const totalAccounts = await getAccountsCount();\n    let scrapedAccounts = 0;\n    let activeSessions = 0;\n    let totalRequestUnits = 0;\n    let usedBudget = 0;\n    try {\n      const scrapedAccountsResult = await query(`\n\t\t\t\tSELECT COUNT(DISTINCT account_id) as count\n\t\t\t\tFROM account_metrics\n\t\t\t`);\n      scrapedAccounts = parseInt(scrapedAccountsResult?.rows?.[0]?.count || \"0\");\n    } catch (error) {\n      console.log(\"account_metrics table not found, using default value 0\");\n    }\n    try {\n      const activeSessionsResult = await query(`\n\t\t\t\tSELECT COUNT(*) as count\n\t\t\t\tFROM scraping_sessions\n\t\t\t\tWHERE status IN ('INITIALIZING', 'RUNNING', 'PAUSED')\n\t\t\t`);\n      activeSessions = parseInt(activeSessionsResult?.rows?.[0]?.count || \"0\");\n    } catch (error) {\n      console.log(\"scraping_sessions table not found, using default value 0\");\n    }\n    try {\n      const now = /* @__PURE__ */ new Date();\n      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);\n      const budgetResult = await query(`\n\t\t\t\tSELECT \n\t\t\t\t\tCOALESCE(SUM(total_request_units), 0) as total_units,\n\t\t\t\t\tCOALESCE(SUM(estimated_cost), 0) as total_cost\n\t\t\t\tFROM scraping_sessions\n\t\t\t\tWHERE created_at >= $1\n\t\t\t`, [monthStart]);\n      totalRequestUnits = parseInt(budgetResult?.rows?.[0]?.total_units || \"0\");\n      usedBudget = parseFloat(budgetResult?.rows?.[0]?.total_cost || \"0\");\n    } catch (error) {\n      console.log(\"scraping_sessions table not found for budget calculation, using default values\");\n    }\n    const monthlyBudget = 100;\n    return {\n      totalAccounts: parseInt(totalAccounts.toString()),\n      scrapedAccounts,\n      activeSessions,\n      totalRequestUnits,\n      monthlyBudget,\n      usedBudget\n    };\n  } catch (error) {\n    console.error(\"Error calculating dashboard stats:\", error);\n    const fallbackCount = await getAccountsCount();\n    return {\n      totalAccounts: parseInt(fallbackCount.toString()),\n      scrapedAccounts: 0,\n      activeSessions: 0,\n      totalRequestUnits: 0,\n      monthlyBudget: 100,\n      usedBudget: 0\n    };\n  }\n}\nexport {\n  GET\n};\n"],"names":[],"mappings":"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"}