{"version":3,"file":"_server.ts-BwE2tzuP.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/scraping/accounts/_server.ts.js"],"sourcesContent":["import { json } from \"@sveltejs/kit\";\nimport { query, getDb } from \"../../../../../chunks/db-loader.js\";\nconst GET = async ({ url, locals }) => {\n  try {\n    const page = parseInt(url.searchParams.get(\"page\") || \"1\");\n    const limit = parseInt(url.searchParams.get(\"limit\") || \"20\");\n    const search = url.searchParams.get(\"search\") || \"\";\n    const status = url.searchParams.get(\"status\") || \"all\";\n    const offset = (page - 1) * limit;\n    let whereConditions = [];\n    let queryParams = [];\n    let paramIndex = 1;\n    if (search.trim()) {\n      whereConditions.push(`ia.instagram_username ILIKE $${paramIndex}`);\n      queryParams.push(`%${search.trim()}%`);\n      paramIndex++;\n    }\n    if (status !== \"all\") {\n      whereConditions.push(`COALESCE(latest_metrics.scraping_status, 'PENDING') = $${paramIndex}`);\n      queryParams.push(status);\n      paramIndex++;\n    }\n    const whereClause = whereConditions.length > 0 ? `WHERE ${whereConditions.join(\" AND \")}` : \"\";\n    const accountsQuery = `\n\t\t\tSELECT \n\t\t\t\tia.id,\n\t\t\t\tia.instagram_username as username,\n\t\t\t\tia.status,\n\t\t\t\tlatest_metrics.last_scraped,\n\t\t\t\tCOALESCE(latest_metrics.scraping_status, 'PENDING') as scraping_status\n\t\t\tFROM ig_accounts ia\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT \n\t\t\t\t\taccount_id,\n\t\t\t\t\tMAX(scraped_at) as last_scraped,\n\t\t\t\t\tscraping_status,\n\t\t\t\t\tROW_NUMBER() OVER (PARTITION BY account_id ORDER BY scraped_at DESC) as rn\n\t\t\t\tFROM account_metrics\n\t\t\t\tGROUP BY account_id, scraping_status, scraped_at\n\t\t\t) latest_metrics ON ia.id = latest_metrics.account_id AND latest_metrics.rn = 1\n\t\t\t${whereClause}\n\t\t\tORDER BY \n\t\t\t\tCASE WHEN latest_metrics.last_scraped IS NOT NULL THEN latest_metrics.last_scraped ELSE ia.created_at END DESC\n\t\t\tLIMIT $${paramIndex} OFFSET $${paramIndex + 1}\n\t\t`;\n    queryParams.push(limit, offset);\n    const countQuery = `\n\t\t\tSELECT COUNT(*) as total\n\t\t\tFROM ig_accounts ia\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT \n\t\t\t\t\taccount_id,\n\t\t\t\t\tscraping_status,\n\t\t\t\t\tROW_NUMBER() OVER (PARTITION BY account_id ORDER BY scraped_at DESC) as rn\n\t\t\t\tFROM account_metrics\n\t\t\t) latest_metrics ON ia.id = latest_metrics.account_id AND latest_metrics.rn = 1\n\t\t\t${whereClause}\n\t\t`;\n    const countParams = queryParams.slice(0, -2);\n    const [accountsResult, countResult] = await Promise.all([\n      query(accountsQuery, queryParams),\n      query(countQuery, countParams)\n    ]);\n    const accounts = accountsResult?.rows || [];\n    const total = parseInt(countResult?.rows?.[0]?.total || \"0\");\n    return json({\n      accounts: accounts.map((account) => ({\n        id: account.id,\n        username: account.username,\n        status: account.status,\n        lastScraped: account.last_scraped,\n        scrapingStatus: account.scraping_status\n      })),\n      total,\n      page,\n      limit,\n      totalPages: Math.ceil(total / limit)\n    });\n  } catch (error) {\n    console.error(\"Accounts API error:\", error);\n    try {\n      const db = await getDb();\n      const fallbackAccounts = await db.getAccounts(20, 0);\n      const totalCount = await db.getAccountsCount();\n      return json({\n        accounts: fallbackAccounts.map((account) => ({\n          id: account.id,\n          username: account.username,\n          status: account.status,\n          lastScraped: null,\n          scrapingStatus: \"PENDING\"\n        })),\n        total: totalCount,\n        page: 1,\n        limit: 20,\n        totalPages: Math.ceil(totalCount / 20)\n      });\n    } catch (fallbackError) {\n      console.error(\"Fallback accounts error:\", fallbackError);\n      return json(\n        { error: \"Failed to load accounts\" },\n        { status: 500 }\n      );\n    }\n  }\n};\nexport {\n  GET\n};\n"],"names":[],"mappings":"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"}