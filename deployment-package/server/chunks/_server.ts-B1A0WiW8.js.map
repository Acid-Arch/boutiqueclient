{"version":3,"file":"_server.ts-B1A0WiW8.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/scraping/profile/_accountId_/_server.ts.js"],"sourcesContent":["import { error, json } from \"@sveltejs/kit\";\nimport { query } from \"../../../../../../chunks/db-loader.js\";\nconst GET = async ({ params, locals }) => {\n  try {\n    const accountId = parseInt(params.accountId);\n    if (isNaN(accountId)) {\n      throw error(400, \"Invalid account ID\");\n    }\n    const profileData = await getCompleteProfileData(accountId);\n    if (!profileData.profile) {\n      throw error(404, \"Profile not found\");\n    }\n    return json({\n      success: true,\n      profile: profileData.profile,\n      recentMedia: profileData.recentMedia || [],\n      scrapingHistory: profileData.scrapingHistory || [],\n      growthData: profileData.growthData || [],\n      metadata: {\n        loadedAt: (/* @__PURE__ */ new Date()).toISOString(),\n        dataPoints: {\n          profile: 1,\n          mediaItems: profileData.recentMedia?.length || 0,\n          historyEntries: profileData.scrapingHistory?.length || 0,\n          growthPoints: profileData.growthData?.length || 0\n        }\n      }\n    });\n  } catch (err) {\n    console.error(\"Profile API error:\", err);\n    if (err && typeof err === \"object\" && \"status\" in err) {\n      throw err;\n    }\n    return json(\n      {\n        success: false,\n        error: \"Failed to load profile data\"\n      },\n      { status: 500 }\n    );\n  }\n};\nasync function getCompleteProfileData(accountId) {\n  try {\n    const profileQuery = `\n\t\t\tSELECT \n\t\t\t\tia.id,\n\t\t\t\tia.instagram_username as username,\n\t\t\t\tia.status as account_status,\n\t\t\t\t\n\t\t\t\t-- Latest metrics from AccountMetrics\n\t\t\t\tam.id as metrics_id,\n\t\t\t\tam.instagram_user_id,\n\t\t\t\tam.display_name,\n\t\t\t\tam.biography,\n\t\t\t\tam.profile_picture_url,\n\t\t\t\tam.profile_picture_url_hd,\n\t\t\t\tam.external_url,\n\t\t\t\t\n\t\t\t\t-- Count metrics\n\t\t\t\tam.followers_count,\n\t\t\t\tam.following_count,\n\t\t\t\tam.posts_count,\n\t\t\t\tam.highlight_reel_count,\n\t\t\t\t\n\t\t\t\t-- Account status flags\n\t\t\t\tam.is_verified,\n\t\t\t\tam.is_private,\n\t\t\t\tam.is_business_account,\n\t\t\t\tam.business_category,\n\t\t\t\tam.business_email,\n\t\t\t\tam.business_phone_number,\n\t\t\t\t\n\t\t\t\t-- Engagement metrics\n\t\t\t\tam.average_likes,\n\t\t\t\tam.average_comments,\n\t\t\t\tam.engagement_rate,\n\t\t\t\tam.reach_rate,\n\t\t\t\tam.impressions,\n\t\t\t\tam.profile_visits,\n\t\t\t\t\n\t\t\t\t-- Content metrics\n\t\t\t\tam.recent_posts_count,\n\t\t\t\tam.stories_posted_24h,\n\t\t\t\tam.reels_count,\n\t\t\t\tam.has_active_stories,\n\t\t\t\tam.last_post_date,\n\t\t\t\tam.last_active_date,\n\t\t\t\t\n\t\t\t\t-- Quality metrics\n\t\t\t\tam.data_quality,\n\t\t\t\tam.scraping_duration,\n\t\t\t\tam.request_units,\n\t\t\t\t\n\t\t\t\t-- Status and timestamps\n\t\t\t\tam.scraping_status,\n\t\t\t\tam.error_message,\n\t\t\t\tam.scraped_at,\n\t\t\t\tam.created_at,\n\t\t\t\tam.updated_at,\n\t\t\t\tam.scraping_session_id\n\t\t\t\t\n\t\t\tFROM ig_accounts ia\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT *,\n\t\t\t\tROW_NUMBER() OVER (PARTITION BY account_id ORDER BY scraped_at DESC) as rn\n\t\t\t\tFROM account_metrics\n\t\t\t) am ON ia.id = am.account_id AND am.rn = 1\n\t\t\t\n\t\t\tWHERE ia.id = $1\n\t\t`;\n    const profileResult = await query(profileQuery, [accountId]);\n    if (!profileResult?.rows || profileResult.rows.length === 0) {\n      return { profile: null };\n    }\n    const profile = profileResult.rows[0];\n    const historyQuery = `\n\t\t\tSELECT \n\t\t\t\tss.id as session_id,\n\t\t\t\tss.session_type,\n\t\t\t\tss.status,\n\t\t\t\tss.progress,\n\t\t\t\tss.start_time,\n\t\t\t\tss.end_time,\n\t\t\t\tss.total_request_units,\n\t\t\t\tss.estimated_cost,\n\t\t\t\tss.error_count,\n\t\t\t\tam.scraped_at,\n\t\t\t\tam.scraping_duration,\n\t\t\t\tam.data_quality,\n\t\t\t\tam.request_units,\n\t\t\t\tam.scraping_status,\n\t\t\t\tam.error_message\n\t\t\tFROM account_metrics am\n\t\t\tLEFT JOIN scraping_sessions ss ON am.scraping_session_id = ss.id\n\t\t\tWHERE am.account_id = $1\n\t\t\tORDER BY am.scraped_at DESC\n\t\t\tLIMIT 20\n\t\t`;\n    const historyResult = await query(historyQuery, [accountId]);\n    const scrapingHistory = (historyResult?.rows || []).map((row) => ({\n      ...row,\n      // Convert PostgreSQL DECIMAL strings to numbers\n      data_quality: row.data_quality ? parseFloat(row.data_quality) : 0,\n      estimated_cost: row.estimated_cost ? parseFloat(row.estimated_cost) : 0,\n      request_units: row.request_units ? parseInt(row.request_units) : 0,\n      scraping_duration: row.scraping_duration ? parseInt(row.scraping_duration) : void 0\n    }));\n    const growthQuery = `\n\t\t\tSELECT \n\t\t\t\tscraped_at as date,\n\t\t\t\tfollowers_count as followers,\n\t\t\t\tfollowing_count as following,\n\t\t\t\tposts_count as posts,\n\t\t\t\tengagement_rate,\n\t\t\t\taverage_likes,\n\t\t\t\taverage_comments,\n\t\t\t\tdata_quality\n\t\t\tFROM account_metrics\n\t\t\tWHERE account_id = $1\n\t\t\tAND scraped_at IS NOT NULL\n\t\t\tORDER BY scraped_at DESC\n\t\t\tLIMIT 30\n\t\t`;\n    const growthResult = await query(growthQuery, [accountId]);\n    const growthData = (growthResult?.rows || []).map((row) => ({\n      ...row,\n      // Convert PostgreSQL DECIMAL strings to numbers\n      engagement_rate: row.engagement_rate ? parseFloat(row.engagement_rate) : 0,\n      data_quality: row.data_quality ? parseFloat(row.data_quality) : 0,\n      average_likes: row.average_likes ? parseFloat(row.average_likes) : void 0,\n      average_comments: row.average_comments ? parseFloat(row.average_comments) : void 0\n    })).reverse();\n    const recentMedia = [];\n    return {\n      profile: {\n        // Map database fields to our interface\n        id: profile.metrics_id,\n        accountId: profile.id,\n        instagramUserId: profile.instagram_user_id,\n        username: profile.username,\n        displayName: profile.display_name,\n        biography: profile.biography,\n        profilePictureUrl: profile.profile_picture_url,\n        profilePictureUrlHd: profile.profile_picture_url_hd,\n        externalUrl: profile.external_url,\n        // Counts\n        followersCount: profile.followers_count || 0,\n        followingCount: profile.following_count || 0,\n        postsCount: profile.posts_count || 0,\n        highlightReelCount: profile.highlight_reel_count,\n        // Status flags\n        isVerified: profile.is_verified || false,\n        isPrivate: profile.is_private || false,\n        isBusinessAccount: profile.is_business_account || false,\n        businessCategory: profile.business_category,\n        businessEmail: profile.business_email,\n        businessPhoneNumber: profile.business_phone_number,\n        // Engagement (convert PostgreSQL DECIMAL strings to numbers)\n        averageLikes: profile.average_likes ? parseFloat(profile.average_likes) : void 0,\n        averageComments: profile.average_comments ? parseFloat(profile.average_comments) : void 0,\n        engagementRate: profile.engagement_rate ? parseFloat(profile.engagement_rate) : 0,\n        reachRate: profile.reach_rate ? parseFloat(profile.reach_rate) : void 0,\n        impressions: profile.impressions ? parseInt(profile.impressions) : void 0,\n        profileVisits: profile.profile_visits ? parseInt(profile.profile_visits) : void 0,\n        // Content\n        recentPostsCount: profile.recent_posts_count,\n        storiesPosted24h: profile.stories_posted_24h,\n        reelsCount: profile.reels_count,\n        hasActiveStories: profile.has_active_stories,\n        lastPostDate: profile.last_post_date,\n        lastActiveDate: profile.last_active_date,\n        // Quality (convert PostgreSQL DECIMAL strings to numbers)\n        dataQuality: profile.data_quality ? parseFloat(profile.data_quality) : 0,\n        scrapingDuration: profile.scraping_duration ? parseInt(profile.scraping_duration) : void 0,\n        requestUnits: profile.request_units ? parseInt(profile.request_units) : 0,\n        // Status\n        scrapingStatus: profile.scraping_status || \"PENDING\",\n        errorMessage: profile.error_message,\n        scrapedAt: profile.scraped_at,\n        createdAt: profile.created_at,\n        updatedAt: profile.updated_at,\n        scrapingSessionId: profile.scraping_session_id\n      },\n      recentMedia,\n      scrapingHistory,\n      growthData\n    };\n  } catch (error2) {\n    console.error(\"Error fetching complete profile data:\", error2);\n    throw new Error(\"Failed to fetch profile data\");\n  }\n}\nexport {\n  GET\n};\n"],"names":[],"mappings":"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"}